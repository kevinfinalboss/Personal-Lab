apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: lavalink
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://https://github.com/kevinfinalboss/Personal-Lab.git 
    targetRevision: HEAD
    path: charts/app-templates/deployment
    helm:
      valueFiles:
        - values.yaml
      values: |
        replicaCount: 1
        
        image:
          repository: "ghcr.io/lavalink-devs/lavalink"
          tag: "4.0.0"
          pullPolicy: IfNotPresent
        
        imagePullSecrets:
          - name: regcred
        
        containerPort: 2333
        
        service:
          type: ClusterIP
          port: 2333
        
        configMap:
          enabled: true
          name: "lavalink-config"
          mountAsFile: true
          mountPath: "/opt/lavalink"
          data:
            application.yml: |
              server:
                port: 2333
                address: 0.0.0.0
                http2:
                  enabled: false
              plugins:
              lavalink:
                server:
                  password: "youshallnotpass"
                  sources:
                    youtube: false
                    bandcamp: true
                    soundcloud: true
                    twitch: true
                    vimeo: true
                    nico: true
                    http: true
                    local: false
                  filters:
                    volume: true
                    equalizer: true
                    karaoke: true
                    timescale: true
                    tremolo: true
                    vibrato: true
                    distortion: true
                    rotation: true
                    channelMix: true
                    lowPass: true
                  nonAllocatingFrameBuffer: false
                  bufferDurationMs: 400
                  frameBufferDurationMs: 5000
                  opusEncodingQuality: 10
                  resamplingQuality: "LOW"
                  trackStuckThresholdMs: 10000
                  useSeekGhosting: true
                  youtubePlaylistLoadLimit: 6
                  playerUpdateInterval: 5
                  youtubeSearchEnabled: true
                  soundcloudSearchEnabled: true
                  gc-warnings: true
              metrics:
                prometheus:
                  enabled: true
                  endpoint: "/metrics"
              sentry:
                dsn: ""
                environment: ""
              logging:
                file:
                  path: ./logs/
                level:
                  root: INFO
                  lavalink: INFO
                request:
                  enabled: true
                  includeClientInfo: true
                  includeHeaders: false
                  includeQueryString: true
                  includePayload: true
                  maxPayloadLength: 10000
                logback:
                  rollingpolicy:
                    max-file-size: 1GB
                    max-history: 30
        
        persistence:
          enabled: true
          storageClass: ""
          accessMode: ReadWriteOnce
          size: 1Gi
          annotations: {}
        
        volumeMounts:
          - name: lavalink-data
            mountPath: /opt/lavalink/logs
        
        volumes:
          - name: lavalink-data
            persistentVolumeClaim:
              claimName: lavalink-pvc
        
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 500m
            memory: 512Mi
        
        metrics:
          enabled: true
          scrape: "true"
          port: 2333
          path: "/metrics"
        
        env:
          - name: JAVA_OPTS
            value: "-Xmx512m -Xms256m"
  destination:
    server: https://kubernetes.default.svc 
    namespace: lavalink 
  syncPolicy:
    automated:
      prune: true 
      selfHeal: true 
    syncOptions:
      - CreateNamespace=true 